{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = undefined;\n\nvar _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require('babel-runtime/helpers/createClass');\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require('babel-runtime/helpers/inherits');\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nvar _api = require('./api');\n\nvar _api2 = _interopRequireDefault(_api);\n\nvar _logger = require('../utils/logger');\n\nvar logger = _interopRequireWildcard(_logger);\n\nvar _errorCode = require('../utils/error-code');\n\nfunction _interopRequireWildcard(obj) {\n  if (obj && obj.__esModule) {\n    return obj;\n  } else {\n    var newObj = {};\n\n    if (obj != null) {\n      for (var key in obj) {\n        if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key];\n      }\n    }\n\n    newObj.default = obj;\n    return newObj;\n  }\n}\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nvar hlsAPI = function (_API) {\n  (0, _inherits3.default)(hlsAPI, _API);\n\n  function hlsAPI(videoDOM, file, Hls) {\n    var _temp, _this2, _ret;\n\n    (0, _classCallCheck3.default)(this, hlsAPI);\n\n    var _this = (_temp = (_this2 = (0, _possibleConstructorReturn3.default)(this, (hlsAPI.__proto__ || (0, _getPrototypeOf2.default)(hlsAPI)).call(this, videoDOM, file)), _this2), _this2.first = true, _temp);\n\n    _this2.file = file;\n\n    if (Hls.isSupported()) {\n      _this2.Hls = Hls;\n      _this2.hlsObj = new Hls({\n        liveDurationInfinity: true,\n        levelLoadingTimeOut: 15000,\n        fragLoadingTimeOut: 25000,\n        enableWorker: true\n      }); //设置默认分辨率根据bandwidth自动选择\n\n      _this2.hlsObj.startLevel = -1;\n    }\n\n    return _ret = _this, (0, _possibleConstructorReturn3.default)(_this2, _ret);\n  } //首次运行\n\n\n  (0, _createClass3.default)(hlsAPI, [{\n    key: 'detachMedia',\n    value: function detachMedia() {\n      var hls = this.hlsObj;\n\n      if (hls) {\n        hls.stopLoad();\n        hls.destroy();\n        logger.success('Detach Media:', 'detach media for hls.js sucessfully.');\n      }\n\n      this.videoDOM.src = '';\n    } //载入视频源，这里不可以用箭头函数\n\n  }, {\n    key: 'loadSource',\n    value: function loadSource(file) {\n      var Hls = this.Hls;\n\n      if (Hls) {\n        //如果已经有了实例化的播放器，先detach\n        var hls = this.hlsObj;\n        hls.detachMedia();\n        hls.loadSource(file);\n        hls.attachMedia(this.videoDOM);\n        logger.info('Source Loading :', 'loading hls video.');\n\n        if (this.first) {\n          this.first = false;\n          this.attachEvent();\n        }\n      }\n    }\n  }, {\n    key: 'attachEvent',\n    value: function attachEvent() {\n      var _this3 = this;\n\n      var hlsObj = this.hlsObj;\n      var Hls = this.Hls;\n      var locale = this.localization;\n\n      if (!hlsObj) {\n        return;\n      }\n\n      var message = void 0;\n      var type = void 0;\n      logger.info('Listening:', 'listening on hls.js events.');\n      var errorTitle = 'Hls.js Error,';\n      var beginDateStamp = 0;\n      var endDateStamp = 0;\n      var fragmentRequestTime = 0;\n      hlsObj.on(Hls.Events.FRAG_LOADING, function () {\n        beginDateStamp = +new Date();\n      });\n      hlsObj.on(Hls.Events.FRAG_LOADED, function (event, data) {\n        endDateStamp = +new Date();\n        fragmentRequestTime = endDateStamp - beginDateStamp;\n        var info = {\n          requestTime: fragmentRequestTime,\n          duration: data.frag.duration,\n          fileSize: data.frag.loaded // file: this.file,\n\n        };\n\n        _this3.event.trigger('hlsFragmentInfo', info);\n      });\n      hlsObj.on(Hls.Events.ERROR, function (event, data) {\n        switch (data.details) {\n          case Hls.ErrorDetails.MANIFEST_LOAD_ERROR:\n            message = locale.fileCouldNotPlay;\n            logger.error(errorTitle, 'cannot Load ' + data.context.url);\n            type = _errorCode.LOAD_ERROR;\n\n            if (data.response !== undefined) {\n              logger.error(errorTitle, 'HTTP response code: ' + data.response.code + ' ' + data.response.text);\n\n              if (data.response.code === 0) {\n                message = locale.fileCouldNotPlay;\n                logger.error(errorTitle, 'this might be a CORS issue, consider installing https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi Allow-Control-Allow-Origin Chrome Extension');\n              }\n            }\n\n            break;\n\n          case Hls.ErrorDetails.MANIFEST_LOAD_TIMEOUT:\n            logger.error(errorTitle, 'timeout while loading manifest');\n            message = locale.timeout;\n            type = _errorCode.TIMEOUT_ERROR;\n            break;\n\n          case Hls.ErrorDetails.MANIFEST_PARSING_ERROR:\n            logger.error(errorTitle, 'error while parsing manifest');\n            message = locale.fileCouldNotPlay;\n            type = _errorCode.CONTENT_PARSING_ERROR;\n            break;\n\n          case Hls.ErrorDetails.LEVEL_LOAD_ERROR:\n            logger.error(errorTitle, 'error while loading level playlist');\n            message = locale.fileCouldNotPlay;\n            type = _errorCode.LOAD_ERROR;\n            break;\n\n          case Hls.ErrorDetails.LEVEL_LOAD_TIMEOUT:\n            message = locale.timeout;\n            type = _errorCode.TIMEOUT_ERROR;\n            logger.error(errorTitle, 'level load timeout');\n            break;\n\n          case Hls.ErrorDetails.LEVEL_SWITCH_ERROR:\n            logger.error(errorTitle, 'error while trying to switch to level ' + data.level);\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            break;\n          //case Hls.ErrorDetails.FRAG_LOAD_ERROR:\n          //console.error('error while loading fragment ' + data.frag.url);\n          //message = locale.unknownError;\n          //type = UNKNOWN_ERROR;\n          //break;\n\n          case Hls.ErrorDetails.FRAG_LOAD_TIMEOUT:\n            logger.error(errorTitle, 'timeout while loading fragment ' + data.frag.url);\n            message = locale.timeout;\n            type = _errorCode.TIMEOUT_ERROR;\n            break;\n\n          case Hls.ErrorDetails.FRAG_LOOP_LOADING_ERROR:\n            logger.error(errorTitle, 'Frag Loop Loading Error');\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            break;\n\n          case Hls.ErrorDetails.FRAG_DECRYPT_ERROR:\n            logger.error(errorTitle, 'Decrypting Error:' + data.reason);\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            break;\n\n          case Hls.ErrorDetails.FRAG_PARSING_ERROR:\n            logger.error(errorTitle, 'Parsing Error:' + data.reason);\n            message = locale.fileCouldNotPlay;\n            type = _errorCode.CONTENT_PARSING_ERROR;\n            break;\n\n          case Hls.ErrorDetails.KEY_LOAD_ERROR:\n            logger.error(errorTitle, 'error while loading key ' + data.frag.decryptdata.uri);\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            break;\n\n          case Hls.ErrorDetails.KEY_LOAD_TIMEOUT:\n            logger.error(errorTitle, 'timeout while loading key ' + data.frag.decryptdata.uri);\n            message = locale.timeout;\n            type = _errorCode.TIMEOUT_ERROR;\n            break;\n\n          case Hls.ErrorDetails.BUFFER_APPEND_ERROR:\n            logger.error(errorTitle, 'Buffer Append Error');\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            break;\n\n          case Hls.ErrorDetails.BUFFER_ADD_CODEC_ERROR:\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            logger.error(errorTitle, 'Buffer Add Codec Error for ' + data.mimeType + ':' + data.err.message);\n            break;\n\n          case Hls.ErrorDetails.BUFFER_APPENDING_ERROR:\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            logger.error(errorTitle, 'Buffer Append Error');\n            break;\n          //case 'fragLoadError':\n          //message = locale.fileCouldNotPlay;\n          //type = LOAD_ERROR;\n          //console.error('fragLoadError Error');\n          //break;\n\n          default:\n            break;\n        } // console.log(message);\n\n\n        logger.error(errorTitle, type, message);\n\n        if (message) {\n          //像buffer错误不用报错\n          _this3.event.trigger('error', {\n            //一般trigger都是为了对外提供api，error是个比较特殊的情况，寄对外提供了事件，也对内提供了事件。\n            //如果只是对内不对外的话，不可以使用trigger处理事件，所有的都用redux。\n            data: data,\n            message: message,\n            type: type,\n            parser: 'hls.js'\n          });\n        }\n\n        if (data.fatal) {\n          switch (data.type) {\n            case Hls.ErrorTypes.MEDIA_ERROR:\n              logger.error(errorTitle, 'media error:', data.details);\n              break;\n\n            case Hls.ErrorTypes.NETWORK_ERROR:\n              logger.error(errorTitle, 'network error:', data.details);\n              break;\n\n            default:\n              logger.error(errorTitle, 'fatal error:', data.details);\n              message = locale.unknownError;\n              type = _errorCode.FATAL_ERROR;\n\n              _this3.event.trigger('error', {\n                //一般trigger都是为了对外提供api，error是个比较特殊的情况，寄对外提供了事件，也对内提供了事件。\n                //如果只是对内不对外的话，不可以使用trigger处理事件，所有的都用redux。\n                data: data,\n                message: message,\n                type: type,\n                parser: 'hls.js'\n              });\n\n              hlsObj.destroy();\n              break;\n          }\n        }\n      });\n    }\n  }]);\n  return hlsAPI;\n}(_api2.default);\n\nexports.default = hlsAPI;","map":{"version":3,"sources":["C:/Users/MaGent/Desktop/video/video/node_modules/html5-player/libs/api/hlsjs-api.js"],"names":["Object","defineProperty","exports","value","default","undefined","_getPrototypeOf","require","_getPrototypeOf2","_interopRequireDefault","_classCallCheck2","_classCallCheck3","_createClass2","_createClass3","_possibleConstructorReturn2","_possibleConstructorReturn3","_inherits2","_inherits3","_api","_api2","_logger","logger","_interopRequireWildcard","_errorCode","obj","__esModule","newObj","key","prototype","hasOwnProperty","call","hlsAPI","_API","videoDOM","file","Hls","_temp","_this2","_ret","_this","__proto__","first","isSupported","hlsObj","liveDurationInfinity","levelLoadingTimeOut","fragLoadingTimeOut","enableWorker","startLevel","detachMedia","hls","stopLoad","destroy","success","src","loadSource","attachMedia","info","attachEvent","_this3","locale","localization","message","type","errorTitle","beginDateStamp","endDateStamp","fragmentRequestTime","on","Events","FRAG_LOADING","Date","FRAG_LOADED","event","data","requestTime","duration","frag","fileSize","loaded","trigger","ERROR","details","ErrorDetails","MANIFEST_LOAD_ERROR","fileCouldNotPlay","error","context","url","LOAD_ERROR","response","code","text","MANIFEST_LOAD_TIMEOUT","timeout","TIMEOUT_ERROR","MANIFEST_PARSING_ERROR","CONTENT_PARSING_ERROR","LEVEL_LOAD_ERROR","LEVEL_LOAD_TIMEOUT","LEVEL_SWITCH_ERROR","level","unknownError","UNKNOWN_ERROR","FRAG_LOAD_TIMEOUT","FRAG_LOOP_LOADING_ERROR","FRAG_DECRYPT_ERROR","reason","FRAG_PARSING_ERROR","KEY_LOAD_ERROR","decryptdata","uri","KEY_LOAD_TIMEOUT","BUFFER_APPEND_ERROR","BUFFER_ADD_CODEC_ERROR","mimeType","err","BUFFER_APPENDING_ERROR","parser","fatal","ErrorTypes","MEDIA_ERROR","NETWORK_ERROR","FATAL_ERROR"],"mappings":"AAAA;;AAEAA,MAAM,CAACC,cAAP,CAAsBC,OAAtB,EAA+B,YAA/B,EAA6C;AAC3CC,EAAAA,KAAK,EAAE;AADoC,CAA7C;AAGAD,OAAO,CAACE,OAAR,GAAkBC,SAAlB;;AAEA,IAAIC,eAAe,GAAGC,OAAO,CAAC,+CAAD,CAA7B;;AAEA,IAAIC,gBAAgB,GAAGC,sBAAsB,CAACH,eAAD,CAA7C;;AAEA,IAAII,gBAAgB,GAAGH,OAAO,CAAC,sCAAD,CAA9B;;AAEA,IAAII,gBAAgB,GAAGF,sBAAsB,CAACC,gBAAD,CAA7C;;AAEA,IAAIE,aAAa,GAAGL,OAAO,CAAC,mCAAD,CAA3B;;AAEA,IAAIM,aAAa,GAAGJ,sBAAsB,CAACG,aAAD,CAA1C;;AAEA,IAAIE,2BAA2B,GAAGP,OAAO,CAAC,iDAAD,CAAzC;;AAEA,IAAIQ,2BAA2B,GAAGN,sBAAsB,CAACK,2BAAD,CAAxD;;AAEA,IAAIE,UAAU,GAAGT,OAAO,CAAC,gCAAD,CAAxB;;AAEA,IAAIU,UAAU,GAAGR,sBAAsB,CAACO,UAAD,CAAvC;;AAEA,IAAIE,IAAI,GAAGX,OAAO,CAAC,OAAD,CAAlB;;AAEA,IAAIY,KAAK,GAAGV,sBAAsB,CAACS,IAAD,CAAlC;;AAEA,IAAIE,OAAO,GAAGb,OAAO,CAAC,iBAAD,CAArB;;AAEA,IAAIc,MAAM,GAAGC,uBAAuB,CAACF,OAAD,CAApC;;AAEA,IAAIG,UAAU,GAAGhB,OAAO,CAAC,qBAAD,CAAxB;;AAEA,SAASe,uBAAT,CAAiCE,GAAjC,EAAsC;AAAE,MAAIA,GAAG,IAAIA,GAAG,CAACC,UAAf,EAA2B;AAAE,WAAOD,GAAP;AAAa,GAA1C,MAAgD;AAAE,QAAIE,MAAM,GAAG,EAAb;;AAAiB,QAAIF,GAAG,IAAI,IAAX,EAAiB;AAAE,WAAK,IAAIG,GAAT,IAAgBH,GAAhB,EAAqB;AAAE,YAAIxB,MAAM,CAAC4B,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCN,GAArC,EAA0CG,GAA1C,CAAJ,EAAoDD,MAAM,CAACC,GAAD,CAAN,GAAcH,GAAG,CAACG,GAAD,CAAjB;AAAyB;AAAE;;AAACD,IAAAA,MAAM,CAACtB,OAAP,GAAiBoB,GAAjB;AAAsB,WAAOE,MAAP;AAAgB;AAAE;;AAE7Q,SAASjB,sBAAT,CAAgCe,GAAhC,EAAqC;AAAE,SAAOA,GAAG,IAAIA,GAAG,CAACC,UAAX,GAAwBD,GAAxB,GAA8B;AAAEpB,IAAAA,OAAO,EAAEoB;AAAX,GAArC;AAAwD;;AAE/F,IAAIO,MAAM,GAAG,UAAUC,IAAV,EAAgB;AAC3B,GAAC,GAAGf,UAAU,CAACb,OAAf,EAAwB2B,MAAxB,EAAgCC,IAAhC;;AAEA,WAASD,MAAT,CAAgBE,QAAhB,EAA0BC,IAA1B,EAAgCC,GAAhC,EAAqC;AACnC,QAAIC,KAAJ,EAAWC,MAAX,EAAmBC,IAAnB;;AAEA,KAAC,GAAG3B,gBAAgB,CAACP,OAArB,EAA8B,IAA9B,EAAoC2B,MAApC;;AAEA,QAAIQ,KAAK,IAAIH,KAAK,IAAIC,MAAM,GAAG,CAAC,GAAGtB,2BAA2B,CAACX,OAAhC,EAAyC,IAAzC,EAA+C,CAAC2B,MAAM,CAACS,SAAP,IAAoB,CAAC,GAAGhC,gBAAgB,CAACJ,OAArB,EAA8B2B,MAA9B,CAArB,EAA4DD,IAA5D,CAAiE,IAAjE,EAAuEG,QAAvE,EAAiFC,IAAjF,CAA/C,CAAT,EAAiJG,MAArJ,CAAL,EAAmKA,MAAM,CAACI,KAAP,GAAe,IAAlL,EAAwLL,KAA5L,CAAT;;AACAC,IAAAA,MAAM,CAACH,IAAP,GAAcA,IAAd;;AACA,QAAIC,GAAG,CAACO,WAAJ,EAAJ,EAAuB;AACrBL,MAAAA,MAAM,CAACF,GAAP,GAAaA,GAAb;AACAE,MAAAA,MAAM,CAACM,MAAP,GAAgB,IAAIR,GAAJ,CAAQ;AACtBS,QAAAA,oBAAoB,EAAE,IADA;AAEtBC,QAAAA,mBAAmB,EAAE,KAFC;AAGtBC,QAAAA,kBAAkB,EAAE,KAHE;AAItBC,QAAAA,YAAY,EAAE;AAJQ,OAAR,CAAhB,CAFqB,CAQrB;;AACAV,MAAAA,MAAM,CAACM,MAAP,CAAcK,UAAd,GAA2B,CAAC,CAA5B;AACD;;AACD,WAAOV,IAAI,GAAGC,KAAP,EAAc,CAAC,GAAGxB,2BAA2B,CAACX,OAAhC,EAAyCiC,MAAzC,EAAiDC,IAAjD,CAArB;AACD,GAtB0B,CAuB3B;;;AAGA,GAAC,GAAGzB,aAAa,CAACT,OAAlB,EAA2B2B,MAA3B,EAAmC,CAAC;AAClCJ,IAAAA,GAAG,EAAE,aAD6B;AAElCxB,IAAAA,KAAK,EAAE,SAAS8C,WAAT,GAAuB;AAC5B,UAAIC,GAAG,GAAG,KAAKP,MAAf;;AACA,UAAIO,GAAJ,EAAS;AACPA,QAAAA,GAAG,CAACC,QAAJ;AACAD,QAAAA,GAAG,CAACE,OAAJ;AACA/B,QAAAA,MAAM,CAACgC,OAAP,CAAe,eAAf,EAAgC,sCAAhC;AACD;;AACD,WAAKpB,QAAL,CAAcqB,GAAd,GAAoB,EAApB;AACD,KAViC,CAWlC;;AAXkC,GAAD,EAahC;AACD3B,IAAAA,GAAG,EAAE,YADJ;AAEDxB,IAAAA,KAAK,EAAE,SAASoD,UAAT,CAAoBrB,IAApB,EAA0B;AAC/B,UAAIC,GAAG,GAAG,KAAKA,GAAf;;AACA,UAAIA,GAAJ,EAAS;AACP;AACA,YAAIe,GAAG,GAAG,KAAKP,MAAf;AACAO,QAAAA,GAAG,CAACD,WAAJ;AACAC,QAAAA,GAAG,CAACK,UAAJ,CAAerB,IAAf;AACAgB,QAAAA,GAAG,CAACM,WAAJ,CAAgB,KAAKvB,QAArB;AACAZ,QAAAA,MAAM,CAACoC,IAAP,CAAY,kBAAZ,EAAgC,oBAAhC;;AACA,YAAI,KAAKhB,KAAT,EAAgB;AACd,eAAKA,KAAL,GAAa,KAAb;AACA,eAAKiB,WAAL;AACD;AACF;AACF;AAhBA,GAbgC,EA8BhC;AACD/B,IAAAA,GAAG,EAAE,aADJ;AAEDxB,IAAAA,KAAK,EAAE,SAASuD,WAAT,GAAuB;AAC5B,UAAIC,MAAM,GAAG,IAAb;;AAEA,UAAIhB,MAAM,GAAG,KAAKA,MAAlB;AACA,UAAIR,GAAG,GAAG,KAAKA,GAAf;AACA,UAAIyB,MAAM,GAAG,KAAKC,YAAlB;;AACA,UAAI,CAAClB,MAAL,EAAa;AACX;AACD;;AACD,UAAImB,OAAO,GAAG,KAAK,CAAnB;AACA,UAAIC,IAAI,GAAG,KAAK,CAAhB;AACA1C,MAAAA,MAAM,CAACoC,IAAP,CAAY,YAAZ,EAA0B,6BAA1B;AACA,UAAIO,UAAU,GAAG,eAAjB;AACA,UAAIC,cAAc,GAAG,CAArB;AACA,UAAIC,YAAY,GAAG,CAAnB;AACA,UAAIC,mBAAmB,GAAG,CAA1B;AACAxB,MAAAA,MAAM,CAACyB,EAAP,CAAUjC,GAAG,CAACkC,MAAJ,CAAWC,YAArB,EAAmC,YAAY;AAC7CL,QAAAA,cAAc,GAAG,CAAC,IAAIM,IAAJ,EAAlB;AACD,OAFD;AAGA5B,MAAAA,MAAM,CAACyB,EAAP,CAAUjC,GAAG,CAACkC,MAAJ,CAAWG,WAArB,EAAkC,UAAUC,KAAV,EAAiBC,IAAjB,EAAuB;AACvDR,QAAAA,YAAY,GAAG,CAAC,IAAIK,IAAJ,EAAhB;AACAJ,QAAAA,mBAAmB,GAAGD,YAAY,GAAGD,cAArC;AACA,YAAIR,IAAI,GAAG;AACTkB,UAAAA,WAAW,EAAER,mBADJ;AAETS,UAAAA,QAAQ,EAAEF,IAAI,CAACG,IAAL,CAAUD,QAFX;AAGTE,UAAAA,QAAQ,EAAEJ,IAAI,CAACG,IAAL,CAAUE,MAHX,CAIT;;AAJS,SAAX;;AAMApB,QAAAA,MAAM,CAACc,KAAP,CAAaO,OAAb,CAAqB,iBAArB,EAAwCvB,IAAxC;AACD,OAVD;AAWAd,MAAAA,MAAM,CAACyB,EAAP,CAAUjC,GAAG,CAACkC,MAAJ,CAAWY,KAArB,EAA4B,UAAUR,KAAV,EAAiBC,IAAjB,EAAuB;AACjD,gBAAQA,IAAI,CAACQ,OAAb;AACE,eAAK/C,GAAG,CAACgD,YAAJ,CAAiBC,mBAAtB;AACEtB,YAAAA,OAAO,GAAGF,MAAM,CAACyB,gBAAjB;AACAhE,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,iBAAiBU,IAAI,CAACa,OAAL,CAAaC,GAAvD;AACAzB,YAAAA,IAAI,GAAGxC,UAAU,CAACkE,UAAlB;;AACA,gBAAIf,IAAI,CAACgB,QAAL,KAAkBrF,SAAtB,EAAiC;AAC/BgB,cAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,yBAAyBU,IAAI,CAACgB,QAAL,CAAcC,IAAvC,GAA8C,GAA9C,GAAoDjB,IAAI,CAACgB,QAAL,CAAcE,IAA3F;;AACA,kBAAIlB,IAAI,CAACgB,QAAL,CAAcC,IAAd,KAAuB,CAA3B,EAA8B;AAC5B7B,gBAAAA,OAAO,GAAGF,MAAM,CAACyB,gBAAjB;AACAhE,gBAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,kMAAzB;AACD;AACF;;AACD;;AACF,eAAK7B,GAAG,CAACgD,YAAJ,CAAiBU,qBAAtB;AACExE,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,gCAAzB;AACAF,YAAAA,OAAO,GAAGF,MAAM,CAACkC,OAAjB;AACA/B,YAAAA,IAAI,GAAGxC,UAAU,CAACwE,aAAlB;AACA;;AACF,eAAK5D,GAAG,CAACgD,YAAJ,CAAiBa,sBAAtB;AACE3E,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,8BAAzB;AACAF,YAAAA,OAAO,GAAGF,MAAM,CAACyB,gBAAjB;AACAtB,YAAAA,IAAI,GAAGxC,UAAU,CAAC0E,qBAAlB;AACA;;AACF,eAAK9D,GAAG,CAACgD,YAAJ,CAAiBe,gBAAtB;AACE7E,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,oCAAzB;AACAF,YAAAA,OAAO,GAAGF,MAAM,CAACyB,gBAAjB;AACAtB,YAAAA,IAAI,GAAGxC,UAAU,CAACkE,UAAlB;AACA;;AACF,eAAKtD,GAAG,CAACgD,YAAJ,CAAiBgB,kBAAtB;AACErC,YAAAA,OAAO,GAAGF,MAAM,CAACkC,OAAjB;AACA/B,YAAAA,IAAI,GAAGxC,UAAU,CAACwE,aAAlB;AACA1E,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,oBAAzB;AACA;;AACF,eAAK7B,GAAG,CAACgD,YAAJ,CAAiBiB,kBAAtB;AACE/E,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,2CAA2CU,IAAI,CAAC2B,KAAzE;AACAvC,YAAAA,OAAO,GAAGF,MAAM,CAAC0C,YAAjB;AACAvC,YAAAA,IAAI,GAAGxC,UAAU,CAACgF,aAAlB;AACA;AACF;AACA;AACA;AACA;AACA;;AACA,eAAKpE,GAAG,CAACgD,YAAJ,CAAiBqB,iBAAtB;AACEnF,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,oCAAoCU,IAAI,CAACG,IAAL,CAAUW,GAAvE;AACA1B,YAAAA,OAAO,GAAGF,MAAM,CAACkC,OAAjB;AACA/B,YAAAA,IAAI,GAAGxC,UAAU,CAACwE,aAAlB;AACA;;AACF,eAAK5D,GAAG,CAACgD,YAAJ,CAAiBsB,uBAAtB;AACEpF,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,yBAAzB;AACAF,YAAAA,OAAO,GAAGF,MAAM,CAAC0C,YAAjB;AACAvC,YAAAA,IAAI,GAAGxC,UAAU,CAACgF,aAAlB;AACA;;AACF,eAAKpE,GAAG,CAACgD,YAAJ,CAAiBuB,kBAAtB;AACErF,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,sBAAsBU,IAAI,CAACiC,MAApD;AACA7C,YAAAA,OAAO,GAAGF,MAAM,CAAC0C,YAAjB;AACAvC,YAAAA,IAAI,GAAGxC,UAAU,CAACgF,aAAlB;AACA;;AACF,eAAKpE,GAAG,CAACgD,YAAJ,CAAiByB,kBAAtB;AACEvF,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,mBAAmBU,IAAI,CAACiC,MAAjD;AACA7C,YAAAA,OAAO,GAAGF,MAAM,CAACyB,gBAAjB;AACAtB,YAAAA,IAAI,GAAGxC,UAAU,CAAC0E,qBAAlB;AACA;;AACF,eAAK9D,GAAG,CAACgD,YAAJ,CAAiB0B,cAAtB;AACExF,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,6BAA6BU,IAAI,CAACG,IAAL,CAAUiC,WAAV,CAAsBC,GAA5E;AACAjD,YAAAA,OAAO,GAAGF,MAAM,CAAC0C,YAAjB;AACAvC,YAAAA,IAAI,GAAGxC,UAAU,CAACgF,aAAlB;AACA;;AACF,eAAKpE,GAAG,CAACgD,YAAJ,CAAiB6B,gBAAtB;AACE3F,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,+BAA+BU,IAAI,CAACG,IAAL,CAAUiC,WAAV,CAAsBC,GAA9E;AACAjD,YAAAA,OAAO,GAAGF,MAAM,CAACkC,OAAjB;AACA/B,YAAAA,IAAI,GAAGxC,UAAU,CAACwE,aAAlB;AACA;;AACF,eAAK5D,GAAG,CAACgD,YAAJ,CAAiB8B,mBAAtB;AACE5F,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,qBAAzB;AACAF,YAAAA,OAAO,GAAGF,MAAM,CAAC0C,YAAjB;AACAvC,YAAAA,IAAI,GAAGxC,UAAU,CAACgF,aAAlB;AACA;;AACF,eAAKpE,GAAG,CAACgD,YAAJ,CAAiB+B,sBAAtB;AACEpD,YAAAA,OAAO,GAAGF,MAAM,CAAC0C,YAAjB;AACAvC,YAAAA,IAAI,GAAGxC,UAAU,CAACgF,aAAlB;AACAlF,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,gCAAgCU,IAAI,CAACyC,QAArC,GAAgD,GAAhD,GAAsDzC,IAAI,CAAC0C,GAAL,CAAStD,OAAxF;AACA;;AACF,eAAK3B,GAAG,CAACgD,YAAJ,CAAiBkC,sBAAtB;AACEvD,YAAAA,OAAO,GAAGF,MAAM,CAAC0C,YAAjB;AACAvC,YAAAA,IAAI,GAAGxC,UAAU,CAACgF,aAAlB;AACAlF,YAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,qBAAzB;AACA;AACF;AACA;AACA;AACA;AACA;;AACA;AACE;AA9FJ,SADiD,CAiGjD;;;AACA3C,QAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyBD,IAAzB,EAA+BD,OAA/B;;AACA,YAAIA,OAAJ,EAAa;AACX;AACAH,UAAAA,MAAM,CAACc,KAAP,CAAaO,OAAb,CAAqB,OAArB,EAA8B;AAC5B;AACA;AACAN,YAAAA,IAAI,EAAEA,IAHsB;AAI5BZ,YAAAA,OAAO,EAAEA,OAJmB;AAK5BC,YAAAA,IAAI,EAAEA,IALsB;AAM5BuD,YAAAA,MAAM,EAAE;AANoB,WAA9B;AAQD;;AACD,YAAI5C,IAAI,CAAC6C,KAAT,EAAgB;AACd,kBAAQ7C,IAAI,CAACX,IAAb;AACE,iBAAK5B,GAAG,CAACqF,UAAJ,CAAeC,WAApB;AACEpG,cAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,cAAzB,EAAyCU,IAAI,CAACQ,OAA9C;AACA;;AACF,iBAAK/C,GAAG,CAACqF,UAAJ,CAAeE,aAApB;AACErG,cAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,gBAAzB,EAA2CU,IAAI,CAACQ,OAAhD;AACA;;AACF;AACE7D,cAAAA,MAAM,CAACiE,KAAP,CAAatB,UAAb,EAAyB,cAAzB,EAAyCU,IAAI,CAACQ,OAA9C;AACApB,cAAAA,OAAO,GAAGF,MAAM,CAAC0C,YAAjB;AACAvC,cAAAA,IAAI,GAAGxC,UAAU,CAACoG,WAAlB;;AACAhE,cAAAA,MAAM,CAACc,KAAP,CAAaO,OAAb,CAAqB,OAArB,EAA8B;AAC5B;AACA;AACAN,gBAAAA,IAAI,EAAEA,IAHsB;AAI5BZ,gBAAAA,OAAO,EAAEA,OAJmB;AAK5BC,gBAAAA,IAAI,EAAEA,IALsB;AAM5BuD,gBAAAA,MAAM,EAAE;AANoB,eAA9B;;AAQA3E,cAAAA,MAAM,CAACS,OAAP;AACA;AApBJ;AAsBD;AACF,OAtID;AAuID;AAvKA,GA9BgC,CAAnC;AAuMA,SAAOrB,MAAP;AACD,CAlOY,CAkOXZ,KAAK,CAACf,OAlOK,CAAb;;AAoOAF,OAAO,CAACE,OAAR,GAAkB2B,MAAlB","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = undefined;\n\nvar _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require('babel-runtime/helpers/createClass');\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require('babel-runtime/helpers/inherits');\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nvar _api = require('./api');\n\nvar _api2 = _interopRequireDefault(_api);\n\nvar _logger = require('../utils/logger');\n\nvar logger = _interopRequireWildcard(_logger);\n\nvar _errorCode = require('../utils/error-code');\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar hlsAPI = function (_API) {\n  (0, _inherits3.default)(hlsAPI, _API);\n\n  function hlsAPI(videoDOM, file, Hls) {\n    var _temp, _this2, _ret;\n\n    (0, _classCallCheck3.default)(this, hlsAPI);\n\n    var _this = (_temp = (_this2 = (0, _possibleConstructorReturn3.default)(this, (hlsAPI.__proto__ || (0, _getPrototypeOf2.default)(hlsAPI)).call(this, videoDOM, file)), _this2), _this2.first = true, _temp);\n    _this2.file = file;\n    if (Hls.isSupported()) {\n      _this2.Hls = Hls;\n      _this2.hlsObj = new Hls({\n        liveDurationInfinity: true,\n        levelLoadingTimeOut: 15000,\n        fragLoadingTimeOut: 25000,\n        enableWorker: true\n      });\n      //设置默认分辨率根据bandwidth自动选择\n      _this2.hlsObj.startLevel = -1;\n    }\n    return _ret = _this, (0, _possibleConstructorReturn3.default)(_this2, _ret);\n  }\n  //首次运行\n\n\n  (0, _createClass3.default)(hlsAPI, [{\n    key: 'detachMedia',\n    value: function detachMedia() {\n      var hls = this.hlsObj;\n      if (hls) {\n        hls.stopLoad();\n        hls.destroy();\n        logger.success('Detach Media:', 'detach media for hls.js sucessfully.');\n      }\n      this.videoDOM.src = '';\n    }\n    //载入视频源，这里不可以用箭头函数\n\n  }, {\n    key: 'loadSource',\n    value: function loadSource(file) {\n      var Hls = this.Hls;\n      if (Hls) {\n        //如果已经有了实例化的播放器，先detach\n        var hls = this.hlsObj;\n        hls.detachMedia();\n        hls.loadSource(file);\n        hls.attachMedia(this.videoDOM);\n        logger.info('Source Loading :', 'loading hls video.');\n        if (this.first) {\n          this.first = false;\n          this.attachEvent();\n        }\n      }\n    }\n  }, {\n    key: 'attachEvent',\n    value: function attachEvent() {\n      var _this3 = this;\n\n      var hlsObj = this.hlsObj;\n      var Hls = this.Hls;\n      var locale = this.localization;\n      if (!hlsObj) {\n        return;\n      }\n      var message = void 0;\n      var type = void 0;\n      logger.info('Listening:', 'listening on hls.js events.');\n      var errorTitle = 'Hls.js Error,';\n      var beginDateStamp = 0;\n      var endDateStamp = 0;\n      var fragmentRequestTime = 0;\n      hlsObj.on(Hls.Events.FRAG_LOADING, function () {\n        beginDateStamp = +new Date();\n      });\n      hlsObj.on(Hls.Events.FRAG_LOADED, function (event, data) {\n        endDateStamp = +new Date();\n        fragmentRequestTime = endDateStamp - beginDateStamp;\n        var info = {\n          requestTime: fragmentRequestTime,\n          duration: data.frag.duration,\n          fileSize: data.frag.loaded\n          // file: this.file,\n        };\n        _this3.event.trigger('hlsFragmentInfo', info);\n      });\n      hlsObj.on(Hls.Events.ERROR, function (event, data) {\n        switch (data.details) {\n          case Hls.ErrorDetails.MANIFEST_LOAD_ERROR:\n            message = locale.fileCouldNotPlay;\n            logger.error(errorTitle, 'cannot Load ' + data.context.url);\n            type = _errorCode.LOAD_ERROR;\n            if (data.response !== undefined) {\n              logger.error(errorTitle, 'HTTP response code: ' + data.response.code + ' ' + data.response.text);\n              if (data.response.code === 0) {\n                message = locale.fileCouldNotPlay;\n                logger.error(errorTitle, 'this might be a CORS issue, consider installing https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi Allow-Control-Allow-Origin Chrome Extension');\n              }\n            }\n            break;\n          case Hls.ErrorDetails.MANIFEST_LOAD_TIMEOUT:\n            logger.error(errorTitle, 'timeout while loading manifest');\n            message = locale.timeout;\n            type = _errorCode.TIMEOUT_ERROR;\n            break;\n          case Hls.ErrorDetails.MANIFEST_PARSING_ERROR:\n            logger.error(errorTitle, 'error while parsing manifest');\n            message = locale.fileCouldNotPlay;\n            type = _errorCode.CONTENT_PARSING_ERROR;\n            break;\n          case Hls.ErrorDetails.LEVEL_LOAD_ERROR:\n            logger.error(errorTitle, 'error while loading level playlist');\n            message = locale.fileCouldNotPlay;\n            type = _errorCode.LOAD_ERROR;\n            break;\n          case Hls.ErrorDetails.LEVEL_LOAD_TIMEOUT:\n            message = locale.timeout;\n            type = _errorCode.TIMEOUT_ERROR;\n            logger.error(errorTitle, 'level load timeout');\n            break;\n          case Hls.ErrorDetails.LEVEL_SWITCH_ERROR:\n            logger.error(errorTitle, 'error while trying to switch to level ' + data.level);\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            break;\n          //case Hls.ErrorDetails.FRAG_LOAD_ERROR:\n          //console.error('error while loading fragment ' + data.frag.url);\n          //message = locale.unknownError;\n          //type = UNKNOWN_ERROR;\n          //break;\n          case Hls.ErrorDetails.FRAG_LOAD_TIMEOUT:\n            logger.error(errorTitle, 'timeout while loading fragment ' + data.frag.url);\n            message = locale.timeout;\n            type = _errorCode.TIMEOUT_ERROR;\n            break;\n          case Hls.ErrorDetails.FRAG_LOOP_LOADING_ERROR:\n            logger.error(errorTitle, 'Frag Loop Loading Error');\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            break;\n          case Hls.ErrorDetails.FRAG_DECRYPT_ERROR:\n            logger.error(errorTitle, 'Decrypting Error:' + data.reason);\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            break;\n          case Hls.ErrorDetails.FRAG_PARSING_ERROR:\n            logger.error(errorTitle, 'Parsing Error:' + data.reason);\n            message = locale.fileCouldNotPlay;\n            type = _errorCode.CONTENT_PARSING_ERROR;\n            break;\n          case Hls.ErrorDetails.KEY_LOAD_ERROR:\n            logger.error(errorTitle, 'error while loading key ' + data.frag.decryptdata.uri);\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            break;\n          case Hls.ErrorDetails.KEY_LOAD_TIMEOUT:\n            logger.error(errorTitle, 'timeout while loading key ' + data.frag.decryptdata.uri);\n            message = locale.timeout;\n            type = _errorCode.TIMEOUT_ERROR;\n            break;\n          case Hls.ErrorDetails.BUFFER_APPEND_ERROR:\n            logger.error(errorTitle, 'Buffer Append Error');\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            break;\n          case Hls.ErrorDetails.BUFFER_ADD_CODEC_ERROR:\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            logger.error(errorTitle, 'Buffer Add Codec Error for ' + data.mimeType + ':' + data.err.message);\n            break;\n          case Hls.ErrorDetails.BUFFER_APPENDING_ERROR:\n            message = locale.unknownError;\n            type = _errorCode.UNKNOWN_ERROR;\n            logger.error(errorTitle, 'Buffer Append Error');\n            break;\n          //case 'fragLoadError':\n          //message = locale.fileCouldNotPlay;\n          //type = LOAD_ERROR;\n          //console.error('fragLoadError Error');\n          //break;\n          default:\n            break;\n        }\n        // console.log(message);\n        logger.error(errorTitle, type, message);\n        if (message) {\n          //像buffer错误不用报错\n          _this3.event.trigger('error', {\n            //一般trigger都是为了对外提供api，error是个比较特殊的情况，寄对外提供了事件，也对内提供了事件。\n            //如果只是对内不对外的话，不可以使用trigger处理事件，所有的都用redux。\n            data: data,\n            message: message,\n            type: type,\n            parser: 'hls.js'\n          });\n        }\n        if (data.fatal) {\n          switch (data.type) {\n            case Hls.ErrorTypes.MEDIA_ERROR:\n              logger.error(errorTitle, 'media error:', data.details);\n              break;\n            case Hls.ErrorTypes.NETWORK_ERROR:\n              logger.error(errorTitle, 'network error:', data.details);\n              break;\n            default:\n              logger.error(errorTitle, 'fatal error:', data.details);\n              message = locale.unknownError;\n              type = _errorCode.FATAL_ERROR;\n              _this3.event.trigger('error', {\n                //一般trigger都是为了对外提供api，error是个比较特殊的情况，寄对外提供了事件，也对内提供了事件。\n                //如果只是对内不对外的话，不可以使用trigger处理事件，所有的都用redux。\n                data: data,\n                message: message,\n                type: type,\n                parser: 'hls.js'\n              });\n              hlsObj.destroy();\n              break;\n          }\n        }\n      });\n    }\n  }]);\n  return hlsAPI;\n}(_api2.default);\n\nexports.default = hlsAPI;"]},"metadata":{},"sourceType":"script"}