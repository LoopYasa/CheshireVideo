{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require('babel-runtime/helpers/createClass');\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nexports.default = function (payload) {\n  return new HlsjsEvents(payload);\n};\n\nvar _video = require('../../video');\n\nvar _logger = require('../../../utils/logger');\n\nvar logger = _interopRequireWildcard(_logger);\n\nfunction _interopRequireWildcard(obj) {\n  if (obj && obj.__esModule) {\n    return obj;\n  } else {\n    var newObj = {};\n\n    if (obj != null) {\n      for (var key in obj) {\n        if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key];\n      }\n    }\n\n    newObj.default = obj;\n    return newObj;\n  }\n}\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nvar HlsjsEvents = function () {\n  function HlsjsEvents(payload) {\n    (0, _classCallCheck3.default)(this, HlsjsEvents);\n    this.api = payload.api;\n    this.dispatch = payload.dispatch;\n    this.config = payload.config;\n\n    if (!this.api.hlsObj) {\n      logger.warn('No hls.js instantiation.');\n      return;\n    }\n\n    this.loaded();\n    logger.info('Listening:', 'listening on some hls.js events.');\n  }\n\n  (0, _createClass3.default)(HlsjsEvents, [{\n    key: 'loaded',\n    value: function loaded() {\n      var _this = this;\n\n      var api = this.api;\n      api.hlsObj.on(api.Hls.Events.MANIFEST_LOADED, function (event, data) {\n        _this.setSubtitle();\n\n        _this.setQuality();\n      });\n    }\n  }, {\n    key: 'setQuality',\n    value: function setQuality() {\n      var api = this.api;\n      var dispatch = this.dispatch;\n      var list = [];\n      api.hlsObj.levels.forEach(function (v, k) {\n        if (v.bitrate) {\n          list.push({\n            label: v.height + 'p',\n            value: k\n          });\n        }\n      });\n\n      if (list[0]) {\n        dispatch({\n          type: _video.namespace + '/pictureQualityList',\n          payload: {\n            list: list\n          }\n        });\n      }\n    }\n  }, {\n    key: 'setSubtitle',\n    value: function setSubtitle() {\n      var api = this.api;\n      var dispatch = this.dispatch; // console.log(api.hlsObj.subtitleTracks);\n\n      var clearIntervalObj = void 0;\n      api.hlsObj.on(api.Hls.Events.SUBTITLE_TRACK_SWITCH, function (event, data) {\n        var currentTextTrack = api.textTracks[data.id];\n        var cues = [];\n\n        if (currentTextTrack) {\n          //vtt没有加载时，切换是没信息的，所以首次切换字幕这里是不会触发dispatch\n          cues = currentTextTrack.cues;\n        }\n\n        logger.info('Subtitle switched');\n        dispatch({\n          type: _video.namespace + '/hlsSubtitleCues',\n          payload: cues\n        });\n      });\n      api.hlsObj.on(api.Hls.Events.SUBTITLE_TRACK_LOADED, function (event, data) {\n        //首次切换字幕，加载字幕才会触发这个事件，第二次切换不会触发。\n        var currentTextTrack = api.textTracks[api.currentSubtitleTrack];\n\n        if (!currentTextTrack) {\n          return;\n        } //防止切换过快没清除。\n\n\n        clearInterval(clearIntervalObj);\n        var tempLength = 0;\n        var k = 0;\n        clearIntervalObj = setInterval(function () {\n          var length = currentTextTrack.cues.length;\n\n          if (currentTextTrack.cues.length > 0 && tempLength !== length) {\n            tempLength = length;\n            dispatch({\n              type: _video.namespace + '/hlsSubtitleCues',\n              payload: currentTextTrack.cues\n            });\n          } else {\n            //因为是异步的无法确定什么时候加载完字幕，字幕也可能分几个片段加载的。\n            if (k >= 2) {\n              logger.info('Subtitle switched'); //如果两次以上length都没变化就判断为，加载完成。\n              //这里不排除网络很差的导致加载字幕出问题，但是这种极端情况，不好处理，也没必要处理。\n              //因为如果网络都差到连2KB的内容都加载不了，也完全播放不了视频了。\n\n              clearInterval(clearIntervalObj);\n            }\n\n            k++;\n          }\n        }, 200);\n      });\n      dispatch({\n        type: _video.namespace + '/subtitleList',\n        payload: {\n          subtitleList: api.hlsObj.subtitleTracks,\n          subtitleId: -1\n        }\n      });\n    }\n  }]);\n  return HlsjsEvents;\n}();","map":{"version":3,"sources":["C:/Users/MaGent/Desktop/video/video/node_modules/html5-player/libs/model/video/events/hlsjs.js"],"names":["Object","defineProperty","exports","value","_classCallCheck2","require","_classCallCheck3","_interopRequireDefault","_createClass2","_createClass3","default","payload","HlsjsEvents","_video","_logger","logger","_interopRequireWildcard","obj","__esModule","newObj","key","prototype","hasOwnProperty","call","api","dispatch","config","hlsObj","warn","loaded","info","_this","on","Hls","Events","MANIFEST_LOADED","event","data","setSubtitle","setQuality","list","levels","forEach","v","k","bitrate","push","label","height","type","namespace","clearIntervalObj","SUBTITLE_TRACK_SWITCH","currentTextTrack","textTracks","id","cues","SUBTITLE_TRACK_LOADED","currentSubtitleTrack","clearInterval","tempLength","setInterval","length","subtitleList","subtitleTracks","subtitleId"],"mappings":"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","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require('babel-runtime/helpers/createClass');\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nexports.default = function (payload) {\n  return new HlsjsEvents(payload);\n};\n\nvar _video = require('../../video');\n\nvar _logger = require('../../../utils/logger');\n\nvar logger = _interopRequireWildcard(_logger);\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar HlsjsEvents = function () {\n  function HlsjsEvents(payload) {\n    (0, _classCallCheck3.default)(this, HlsjsEvents);\n\n    this.api = payload.api;\n    this.dispatch = payload.dispatch;\n    this.config = payload.config;\n    if (!this.api.hlsObj) {\n      logger.warn('No hls.js instantiation.');\n      return;\n    }\n    this.loaded();\n    logger.info('Listening:', 'listening on some hls.js events.');\n  }\n\n  (0, _createClass3.default)(HlsjsEvents, [{\n    key: 'loaded',\n    value: function loaded() {\n      var _this = this;\n\n      var api = this.api;\n      api.hlsObj.on(api.Hls.Events.MANIFEST_LOADED, function (event, data) {\n        _this.setSubtitle();\n        _this.setQuality();\n      });\n    }\n  }, {\n    key: 'setQuality',\n    value: function setQuality() {\n      var api = this.api;\n      var dispatch = this.dispatch;\n      var list = [];\n      api.hlsObj.levels.forEach(function (v, k) {\n        if (v.bitrate) {\n          list.push({\n            label: v.height + 'p',\n            value: k\n          });\n        }\n      });\n      if (list[0]) {\n        dispatch({\n          type: _video.namespace + '/pictureQualityList',\n          payload: {\n            list: list\n          }\n        });\n      }\n    }\n  }, {\n    key: 'setSubtitle',\n    value: function setSubtitle() {\n      var api = this.api;\n      var dispatch = this.dispatch;\n      // console.log(api.hlsObj.subtitleTracks);\n      var clearIntervalObj = void 0;\n      api.hlsObj.on(api.Hls.Events.SUBTITLE_TRACK_SWITCH, function (event, data) {\n        var currentTextTrack = api.textTracks[data.id];\n        var cues = [];\n        if (currentTextTrack) {\n          //vtt没有加载时，切换是没信息的，所以首次切换字幕这里是不会触发dispatch\n          cues = currentTextTrack.cues;\n        }\n        logger.info('Subtitle switched');\n        dispatch({\n          type: _video.namespace + '/hlsSubtitleCues',\n          payload: cues\n        });\n      });\n      api.hlsObj.on(api.Hls.Events.SUBTITLE_TRACK_LOADED, function (event, data) {\n        //首次切换字幕，加载字幕才会触发这个事件，第二次切换不会触发。\n        var currentTextTrack = api.textTracks[api.currentSubtitleTrack];\n        if (!currentTextTrack) {\n          return;\n        }\n        //防止切换过快没清除。\n        clearInterval(clearIntervalObj);\n        var tempLength = 0;\n        var k = 0;\n        clearIntervalObj = setInterval(function () {\n          var length = currentTextTrack.cues.length;\n          if (currentTextTrack.cues.length > 0 && tempLength !== length) {\n            tempLength = length;\n            dispatch({\n              type: _video.namespace + '/hlsSubtitleCues',\n              payload: currentTextTrack.cues\n            });\n          } else {\n            //因为是异步的无法确定什么时候加载完字幕，字幕也可能分几个片段加载的。\n            if (k >= 2) {\n              logger.info('Subtitle switched');\n              //如果两次以上length都没变化就判断为，加载完成。\n              //这里不排除网络很差的导致加载字幕出问题，但是这种极端情况，不好处理，也没必要处理。\n              //因为如果网络都差到连2KB的内容都加载不了，也完全播放不了视频了。\n              clearInterval(clearIntervalObj);\n            }\n            k++;\n          }\n        }, 200);\n      });\n      dispatch({\n        type: _video.namespace + '/subtitleList',\n        payload: {\n          subtitleList: api.hlsObj.subtitleTracks,\n          subtitleId: -1\n        }\n      });\n    }\n  }]);\n  return HlsjsEvents;\n}();"]},"metadata":{},"sourceType":"script"}